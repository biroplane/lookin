<!DOCTYPE html>
<html>

<head>
  <script data-pace-options='{ "ajax": true }' src="./public/js/pace.min.js"></script>
  <meta charset="UTF-8">
  <title>Look In Demo - V 2.0.01</title>

  <link rel="stylesheet" href="./public/css/_bootstrap.css">

  <!-- <link rel="stylesheet" href="./public/css/bootstrap-table.min.css"> -->



  <link rel="stylesheet" href="./public/css/pace.css">
  <link rel="stylesheet" href="./public/css/datatables.min.css" />
  <link rel="stylesheet" href="./public/css/jquery-ui.min.css">
  <!-- <link rel="stylesheet" href="./public/css/jquery-ui.structure.min.css"> -->
  <link rel="stylesheet" href="./public/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="./public/css/datatables.min.css">
  <link rel="stylesheet" href="./public/css/datepicker.min.css">
  <link rel="stylesheet" href="./public/css/main.css">
  <!-- <script src="././public/js/jquery-3.1.1.min.js"></script> -->
  <script>
    window.$ = window.jQuery = require('jquery');
  </script>
  <!-- <script src="./public/js/jsgrid.min.js"></script> -->
  <script src="./public/js/bootstrap.min.js"></script>
  <script src="./public/js/jquery-ui.min.js"></script>
  <!-- <script src="./public/js/datatables.min.js"></script>
    <script src="./public/js/dataTables.bootstrap.min.js"></script>

    <script src="./public/js/dataTables.buttons.min.js"></script>
    <script src="./public/js/buttons.html5.min.js"></script> -->
  <script src="./public/js/bootstrap-select.min.js"></script>
  <script src="./public/js/bootstrap-editable.js"></script>
  <!--   <script src="./public/js/jszip.min.js"></script> -->
  <script src="./public/js/moment.js"></script>
  <script src="./public/js/datepicker.min.js"></script>
  <script src="./public/js/datepicker.en.js"></script>

  <script src="./public/js/validator.min.js"></script>

</head>

<body>
  <nav class="navbar navbar-fixed-bottom">
    <div class="container-fluid">
      <div class="text-right infouser">
        <p class="username"></p>
        <div class="icon"><i class="fa fa-2x fa-user-circle-o" aria-hidden="true"></i></div>
      </div>
    </div>



  </nav>
  <div class="container-fluid">
    <div class="row">
      <div class="sync col-xs-4"><button class="btn btn-block"><i class="fa fa-database fa-fw" aria-hidden="true"></i> SYNC</button></div>
      <div class="download col-xs-4 glow"><button class="btn btn-block"><i class="fa fa-refresh fa-fw" aria-hidden="true"></i> UPDATE <span class='newversion'></span></button></div>
      <div class="exit col-xs-4"><button class="btn btn-block"><i class="fa fa-power-off" aria-hidden="true"></i> EXIT</button></div>
    </div>
  </div>
  <hr />
  <div class="container-fluid">
    <div class="row">
      <ul class="nav nav-tabs" role="tablist">
        <li class=""><a href="#reporttab" role="tab" data-toggle="tab" data-node="report">REPORT</a></li>
        <li><a href="#administrationtab" role="tab" data-toggle="tab" data-node="report_acc">ADMINISTRATION</a></li>
        <li><a href="#analisystab" role="tab" data-toggle="tab" data-node="report_any">ANALISYS</a></li>

      </ul>
    </div>
    <div class="tab-content">
      <div id="reporttab" class="tab-pane">
        <div class="row tables ">
          <div class="form-group col-xs-12">
            <br>
            <select class="selectpicker reportselect" title="REPORT" data-live-search="false" name="report" id="report">

            </select>
          </div>
        </div>
        <div class="row types ">

        </div>
        <div class="row mainfilters no-gutters">
        </div>
        <!-- END MAINFILTER -->
        <div class="row createview">
          <div class="form-group">
            <button class="btn btn-default btn-block"><i class="fa fa-rocket" aria-hidden="true"></i> GO</button>
          </div>
        </div>

      </div>

      <div id="administrationtab" class="tab-pane">


        <div class="row tables ">
          <div class="form-group col-xs-12">

            <br>
            <select class="selectpicker reportselect" title="ADMINISTRATION" data-live-search="false" name="report" id="report">

              </select>
          </div>
        </div>
        <div class="row types ">

        </div>
        <div class="row mainfilters no-gutters">
        </div>
        <!-- END MAINFILTER -->
        <div class="row createview">
          <div class="form-group">
            <button class="btn btn-default btn-block"><i class="fa fa-rocket" aria-hidden="true"></i> GO</button>
          </div>
        </div>
      </div>
      <div id="analisystab" class="tab-pane">
        <div class="row tables ">

          <div class="form-group col-xs-12">

            <br>
            <select class="selectpicker reportselect" title="ANALISYS" data-live-search="false" name="report" id="report">

              </select>
          </div>
        </div>
        <div class="row types ">

        </div>
        <div class="row mainfilters no-gutters">
        </div>
        <div class="row createview">
          <div class="form-group">
            <button class="btn btn-default btn-block"><i class="fa fa-rocket" aria-hidden="true"></i> GO</button>
          </div>
        </div>
      </div>

    </div>



    <!-- <div class="row lp">
      <div class="form-group">
        <button class="btn btn-default btn-block loadpage"><i class="fa fa-linkedin-square" aria-hidden="true"></i> LOAD</button>
      </div>
    </div> -->

  </div>

  </div>
  <div id="backdrop">
    <div class="container">
      <form class="form-signin" method="post" id="loginform" action="#">
        <input type="hidden" name="all" value="yes">
        <h2 class="form-signin-heading"><img src="./public/img/LogoLookin.png" alt="Logo" ></h2>
        <div class="input-group margin-bottom-sm"> <span class="input-group-addon"><i class="fa fa-user-circle-o fa-fw" aria-hidden="true"></i></span>
          <label for="inputEmail" class="sr-only">Email address</label>
          <input class="form-control" id="inputEmail" type="text" placeholder="Username" required autofocus autocomplete="off" name="username"> <span class="okform hidden input-group-addon"><i class="fa fa-check fa-fw" aria-hidden="true"></i></span></div>
        <div class="input-group"> <span class="input-group-addon"><i class="fa fa-key fa-fw" aria-hidden="true"></i></span>
          <label for="inputPassword" class="sr-only">Password</label>
          <input class="form-control" id="inputPassword" type="password" placeholder="Password" required name="password"> <span class="okpass hidden input-group-addon"><i class="fa fa-check fa-fw" aria-hidden="true"></i></span> <span class="kopass hidden input-group-addon"><i class="fa fa-times fa-fw" aria-hidden="true"></i></span></div>
        <button id="loginbutton" class="btn btn-lg btn-primary btn-block" type="submit">Log in</button>

      </form>
    </div>
  </div>
  <div id="syncBlock">
    <div class="blink">
      <h2>SYNCING</h2>
      <div class="progress">
        <div class="progress-bar progress-bar-warning progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 1%">
        </div>

      </div>
      <p class="remaining">

      </p>
    </div>

  </div>
</body>

<script>
  //require('./index.js');


  var start = moment().subtract(1, 'months').format("YYYY-MM-DD");
  var end = moment().format("YYYY-MM-DD");
  var express = require('express');
  var restapi = express();
  const path = require('path')
  const url = require('url');
  var md5 = require('md5');
  var sha1 = require('sha1');
  var fs = require('fs');

  // DATE VARS
  from = '';
  // to = '';
  format = ''
  period = ''
  calendarview = 'days';
  datapicker = '';
  datafilter = '';
  lastDate='';
  ipcArg={};
  ////////////////////////

  const {
    BrowserWindow
  } = require('electron').remote;
  const {
    autoUpdater
  } = require('electron').remote;

  let windows = [];
  global.config = {};
  global.report = {};
  global.reportID = -1;
  var reportdatasend = {};
  const isOnline = require('is-online');
  var remote = require('electron').remote;
  const {
    dialog
  } = require('electron').remote;
  const DOCUMENTS = remote.app.getPath('documents');
  //myLog(" DOCUMENTS FROM HTML ", DOCUMENTS);

  var logindata = {};
  var reportoption = '';
  const {
    ipcRenderer
  } = require('electron');
  //var ipcMain = remote.ipcMain;
  //var isOnline = true;
  var filters = {};


  ipcRenderer.on('onSyncDoner', (evt, arg) => {
    //alert("DICONO "+arg)
    $('div#syncBlock').slideUp({
      easing: "easeOutBounce",
      duration: 1000
    })
  })
  ipcRenderer.on('onSyncStart', (evt, arg) => {
    //alert("PARTITOOOOOOO");
    $('div#syncBlock').slideDown({
      easing: "easeOutBounce",
      duration: 1000
    })
  })
  ipcRenderer.on('onSyncFinish', (evt, arg) => {
    //ipcRenderer.sendSync('onOpenDB',true);
    $('div#syncBlock').slideUp({
      easing: "easeOutBounce",
      duration: 1000
    })
  })

  ipcRenderer.on('onWriteConfig', (evt, arg) => {
    if (arg == true) {
      openFileConfig()
    }
  })
  ipcRenderer.on('utenteLoggato', (evt, arg) => {
    if (arg == true) {
      $('#backdrop').slideUp({
        easing: "easeOutBounce",
        duration: 1
      });
      openFileConfig();
    } else {
      ////myLog("UTENTE NON LOGGATO");
    }
  })
  ipcRenderer.on('checkForDBResponse',(evt,arg)=>{
   console.log("CONTROLLO RISPOSTA CHECKDB",arg);
    if(arg==false){
      dialog.showMessageBox({
        type: 'info',
        title: 'Database Missing',
        message: 'Seems that from last update, something hash changed. Lookin needs another file to be downloaded.\nWould You Download it?!',
        buttons: ['Sure', 'No']
      }, (buttonIndex) => {
        if (buttonIndex === 0) {
         console.log("PROCEDI CON IL Download");
          $('.sync').trigger('click');
        }else{
         console.log("NIENTE DOWNLOAD");
        }

      })
    }else{
      //////////////////////
    }
  })

  ipcRenderer.on('wrongLogIn', (evt, arg) => {
    $('#loginform').effect("shake")
    $('#loginform input').val("")
  })
  ipcRenderer.on('updateAvailable', (evt, arg) => {
    //alert("UPDATE AVAILABLE");
    $('.download').show();
  })
  // var soapurl = "http://192.168.43.214/LookinWebservice/LookinWebService.asmx?wsdl&op=GetSyncString_AnaSupervisori";
  // var args = {
  //   user: "gaetano"
  // };
  var activeTab;
  var targetID
  $().ready(function() {

    ipcRenderer.send('checkSoftwareUpdates', true);
    $('.download').hide();
    //$('.download .btn').addClass('glow');
    /* ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
     * ┃         _________   ___  ____        ┃
     * ┃        /_  __/ _ | / _ )/ __/        ┃
     * ┃         / / / __ |/ _  |\ \          ┃
     * ┃        /_/ /_/ |_/____/___/          ┃
     * ┃                                      ┃
     * ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
     */
    $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
      var active = $(e.target).attr("data-node") // activated tab
      targetID = $(e.target).attr("href") // activated tab
      activeTab = active
     console.log("ACTIVE TAB", activeTab, config[activeTab]);
      //alert("CLICK SU TAB");
      reportOption(config[activeTab], $(targetID).find('.selectpicker'));
      $('.mainfilters').empty();
      $('.types').empty();
      $('.createview').hide();
      $('.getanalisys').hide();

      if(activeTab=='report_any'){
        db='analytics.db';
      }else{
        db='lookin.db';
      }
      cambiaDB(db);
    });
    //////myLog("TAB ", $('.nav li.active a'));
    // activeTab = $('.nav li.active a');

    /*–––––––––––––––––––––––––––––––––––––––*/
    /*–––––––––––––––––––––––––––––––––––––––*/
    /*–––––––––––––––––––––––––––––––––––––––*/
    /*–––––––––––––––––––––––––––––––––––––––*/
    /*–––––––––––––––––––––––––––––––––––––––*/

    if (require('electron').remote.getGlobal('loggato') == true) {

      $('#backdrop').slideUp({
        easing: "easeOutBounce",
        duration: 1
      });
      openFileConfig();
    } else {
      ////myLog("UTENTE NON LOGGATO");
    }
    $('div#syncBlock').hide();
    $('.mainfilters').hide();
    $('.createview').hide();
    $('.getanalisys').hide();

    $('.container-fluid').on('resize', function() {

      mainWindow.setSize($(this).width(), $(this).height(), true)
    })

    $('#loginbutton').on('click', function(e) {

      e.preventDefault()
      logindata.username = $('#inputEmail').val();
      logindata.password = md5(sha1($('#inputPassword').val()));

      soapData = {};
      //myLog("ESISTE " + fs.existsSync(path.join(DOCUMENTS, 'lookin', 'lookin.db')))
      if (fs.existsSync(path.join(DOCUMENTS, 'lookin', 'lookin.db')) === true) {


        $.ajax({
          dataType: "json",
          contentType: "application/json",
          url: path.join(DOCUMENTS, 'lookin', 'config.json'),
          type: "GET",
          //data:JSON.parse(JSON.stringify(logindata)),
          success: function(data) {
            //alert("INVIATO "+data);
            //myLog("DATA RECIVED"+ data);
            if (data.app[0].user_name == logindata.username && data.app[0].psw == logindata.password) {
              //myLog("LOGIN OK");
              ipcRenderer.send('setUserId', {
                user: logindata.username
              })

              $('#backdrop').slideUp({
                easing: "easeOutBounce",
                duration: 1000
              });
              openFileConfig();
              $.ajax({
                url: 'http://localhost:3000/lastdate/',
              })
              .done(function(data) {
                lastDate=data.LASTDATE;
              })
              .fail(function() {
                console.log("error");
              })
              .always(function() {
                console.log("complete");
              });

            } else {
              //myLog("LOGIN ERRATO");
              $('#loginform').effect("shake")
              $('#loginform input').val("");
            }

          },
          error: function(a, b, c) {
           console.log("ERRORE",a,b,c);

          }
          //
        })
        ipcRenderer.send('checkForDB',{db:'analytics.db'});
      } else {
        //myLog("IL DATABASE NON ESISTE, LOG VIA SOAP");
        var wantsToDownload = dialog.showMessageBox({
          type: "warning",
          title: "First Access",
          buttons: ["Ok", "No, thank you"],
          detail: "You Need an internet connection to perform the download.\nIt may takes serveral minutes to complete the process..\nPlease wait until the software restarts.",
          message: "Seems that no db file was found.\nIt could be because it's your first access or someone deleted the files.\nWould you download them now?"
        }, function(res) {
          //myLog("LA RISPOSTA è " + res);
          if (res == 0) {
            isOnline({
              timeout: 500
            }).then(online => {
              //myLog("ONLINE STATUS", online);
              if (online) {
                soapData.user = logindata.username;
                soapData.psw = logindata.password;
                //myLog("INVIO DATA ", soapData, logindata.password);
                ipcRenderer.send('onSoapLogin', soapData)
              } else {
                dialog.showErrorBox('Connection Needed', 'LookIn needs a stable internet connection to conect to its services. Please connect to internet and try again')
              }
            })
          }
        })
        //myLog("WANTS TO DOWNLOAD ?",wantsToDownload);

      }
    })
    $('.sync').on('click', function(e) {
      e.preventDefault();
      if (closeAllWindows()) {
        isOnline({
          timeout: 500
        }).then(online => {
          if (online) {

            ipcArg.user= logindata.username;
            ipcArg.psw=logindata.password;
            ipcArg.sData=lastDate;
            ipcRenderer.send("downloadDBFile", ipcArg);
            $('div#syncBlock').show();
            //ipcRenderer.send("downloadDBFile",true);
          } else {
            dialog.showErrorBox('Connection Needed', 'LookIn needs a stable internet connection to conect to its services. Please connect to internet and try again')
          }
        })
      }
    })
    $('.download').on('click', function(e) {
      ipcRenderer.send("download", true);
      console.log("UPDATE ",autoUpdater.checkForUpdates());
    })


    $('.getanalisys').on("click", "button", function(e) {
      e.preventDefault();
      rid = $(targetID + ' .reportselect option').eq(parseInt(reportID) + 1).text().toUpperCase() + "_";
      period = $(targetID + ' #dates').find('.active').find('input').val() || '';
      var currentview = 'BFS_VIEW_' + rid +period;
     console.log("DOPO IL CLICK CURRENTVIEW VALE ",currentview);
      currentview = (currentview.lastIndexOf("_") == (currentview.length - 1)) ? currentview.substring(0, currentview.length - 1) : currentview;
      windows.push(new BrowserWindow({
        width: 1300,
        height: 800,
        x: 500,
        /* titleBarStyle: 'hidden-inset',*/
        title: currentview
      }))

      filters = {};
      var thisFilterTab = '#' + activeTab + ' .mainfilters';
      //myLog("CURRENT VIEW PRIMA DEL CICLO", $(targetID), thisFilterTab);
      $(targetID + ' .mainfilters').each(function() {
        $(this).find('select').each(function() {
          filters[$(this).attr('name')] = this.value;
        })
        $(this).find('input[name=daterange]').each(function() {
          //myLog("AGGIUNGO LE DATE ", $(this).val());
          //myLog("DATE PRESENTI",from,to);
          datafilter = '';
          switch (period) {
            case "DAY":
              datafilter = "DATA_LOG"
              break;
            case "WEEK":
              datafilter = "WEEK"
              break;
            case "MONTH":
              datafilter = "MONTH"
              break;
            case "YEAR":
              datafilter = "YEAR"
              break;
            default:
              datafilter = "DATA_LOG"
              break;
          }
        })
        if (activeTab != 'report') datafilter = "DATA"
        filters[datafilter] = from
        //filters[datafilter+'_TO']=to
      });
     console.log("VIEWNAME ",currentview);
      reportdatasend.viewname = currentview;
      reportdatasend.data = JSON.stringify(getObjects(config[activeTab], 'nome', "IMPORT"))
      reportdatasend.tabs = activeTab
      var len = (windows.length - 1) > 0 ? windows.length - 1 : 0;

      windows[len].loadURL("http://localhost:3000/analisyspage/"+currentview);
      windows[len].on('closed', function(a, b, c) {
        ////myLog("CHIUDO ", windows, a, b, c)
        windows.splice(len, 1)
      })
      ipcRenderer.send('onCreateView', reportdatasend);
    })
    $('.createview').on("click", 'button', function(e) {

      //begin = $('.date-from').val() || moment().subtract(1, 'months').format("YYYY-MM-DD");
      //terminate = $('.date-to').val() || moment().add(1, 'months').format("YYYY-MM-DD");
      rid = $(targetID + ' .reportselect option').eq(parseInt(reportID) + 1).text().toUpperCase() + "_";
      suppl = ($(targetID + ' #ACCB-BAR').find('.active').find('input').val()) ? $(targetID + ' #ACCB-BAR').find('.active').find('input').val() + '_' : '';
      //   //
      viewtype = ($(targetID + ' #ANA-STOR').find('.active').find('input').val()) ? $(targetID + ' #ANA-STOR').find('.active').find('input').val().toString().toUpperCase() + '_' : '';
      whare = ($(targetID + ' #ALL-IMP-OLA').find('.active').find('input').val()) ? $(targetID + ' #ALL-IMP-OLA').find('.active').find('input').val().toString() + '_' : '';
      period = $(targetID + ' #dates').find('.active').find('input').val() || '';

      barsel = ($(targetID + ' #SEL-BAR').find('.active').find('input').val()) ? $(targetID + ' #SEL-BAR').find('.active').find('input').val().toString() + '_' : '';

      var currentview = 'BFS_VIEW_' + rid + viewtype + suppl + whare + barsel + period;
      currentview = (currentview.lastIndexOf("_") == (currentview.length - 1)) ? currentview.substring(0, currentview.length - 1) : currentview;
      filters = {};
      var thisFilterTab = '#' + activeTab + ' .mainfilters';
      //myLog("CURRENT VIEW PRIMA DEL CICLO", $(targetID), thisFilterTab);
      $(targetID + ' .mainfilters').each(function() {
        $(this).find('select').each(function() {
          filters[$(this).attr('name')] = this.value;
        })
        $(this).find('input[name=daterange]').each(function() {
          //myLog("AGGIUNGO LE DATE ", $(this).val());
          //myLog("DATE PRESENTI",from,to);
          datafilter = '';
          switch (period) {
            case "DAY":
              datafilter = "DATA_LOG"
              break;
            case "WEEK":
              datafilter = "WEEK"
              break;
            case "MONTH":
              datafilter = "MONTH"
              break;
            case "YEAR":
              datafilter = "YEAR"
              break;
            default:
              datafilter = "DATA_LOG"
              break;
          }
        })
        if (activeTab != 'report') datafilter = "DATA"
        filters[datafilter] = from
        //filters[datafilter+'_TO']=to
      });
      //myLog("FILTRI DA VISUALIZZARE ", filters, currentview);
      //ipcRenderer.send('activateview','VIEW ATTIVATA! ')
      ////myLog(filters);
      reportdatasend.viewname = currentview;
      reportdatasend.data = JSON.stringify(getObjects(config[activeTab], 'nome', currentview))
      reportdatasend.tabs = activeTab

      ////myLog("REPORT DATA SEND",getObjects(config[activeTab], 'nome', currentview),config[activeTab]);
      windows.push(new BrowserWindow({
        width: 1300,
        height: 800,
        x: 500,
        titleBarStyle: 'hidden-inset',
        title: currentview + " | " + from,
        "web-preferences": {
          "web-security": false
        }
      }))
      //windows[window.length].loadURL(`file://${__dirname}/view.html`);
      var len = (windows.length - 1) > 0 ? windows.length - 1 : 0;
      //begin = (period == 'DAY') ? begin : '';
      gf = '';

      for (var f in filters) {
        if (filters[f] != null && filters[f] != '') {
          gf += f + '=' + filters[f] + '&';

        }
      }
     console.log("GET FILTERS ", gf);
      windows[len].loadURL("http://localhost:3000/data/" + currentview + '?' + gf);
      windows[len].on('closed', function(a, b, c) {
        ////myLog("CHIUDO ", windows, a, b, c)
        windows.splice(len, 1)
      })
      ipcRenderer.send('onCreateView', reportdatasend);
      ////myLog("CARICO LA VISTA ", currentview);
    })
    $('.loadpage').on("click", function(e) {
      e.preventDefault();

    })



  });
  //END ON READY


  $('.exit').on("click", 'button', function() {
    if (closeAllWindows()) {
      require("electron").remote.app.quit();
    }
  })

  $(".reportselect").on('change', function() {
    $('.mainfilters').show();
    $('.createview').show();
    $('.getanalisys').show();
    filters = {};
    var report = $(this).val();
   console.log("CONFIG ", report);

    enableFilters(report, activeTab)
  })

function cambiaDB(dbname) {
  ipcRenderer.send('changeDatabase',{dbname:dbname})
}

  function updateProgressBar(val, sec) {
    $('.progress-bar').css('width', val + '%').attr('aria-valuenow', val);
    sec=parseInt(sec*100)/100 || 0;
    $('.remaining').html(sec + " seconds left")
  }



  function enableFilters(report, tab) {
   console.log("-----ENABLE FILTERS------", report, tab);
    reportID = report
    $('.mainfilters').empty();
    $('.types').empty();

    var node = config[tab][report];
    var filters = '';
    var types = '';
    format = "YYYY-MM-DD";
   console.log("NODE ", node, node.filters)
    if (node.filters) {
      filters += '<div class="form-group col-xs-12 text-center">\n\t<label for="from">Filter by</label><br>\n';
      for (var p in node.filters) {

        if (node.filters[p].type == "select") {
          filters += selectBox(node.filters[p].nome, node.filters[p].values);

        }
        if (node.filters[p].type == "date") {
          filters += bfsdatepicker(from,true);
        }
      }
      filters += '</div>'
      $(filters).appendTo('.mainfilters');
    }
    if (node.groupby) {
      ////myLog("INVIO ", node.groupby);
      dates = '<div class="row dates ">\n\t<div class="form-group col-xs-12 text-center">\n\t<label for="period">Period</label>   <br>';
      dates += option('dates', node.groupby.type, node.groupby.values);
      dates += '</div></div>';
      $(dates).appendTo('.types')
    }
    if (node.tipologia) {
      ////myLog("INVIO TIPOLOGIA", node.tipologia.length);
      for (var t in node.tipologia) {
        types += '<div class="form-group col-xs-6 text-center">\n\t<label for="from">From</label><br>\n';
        types += option(node.tipologia[t].nome, node.tipologia[t].type, node.tipologia[t].values);
        types += '</div>';
      }
      $(types).appendTo('.types');

    }

    $('.selectpicker').selectpicker("refresh");

    datepicker = $('input[name="daterange"]').datepicker({
      language: "en",
      toggleSelected:false,
      minView: calendarview,
      dateFormat: format.toLowerCase(),
      view: calendarview,
      /*range: false,*/
      maxDate: new Date(),
      position: "top left",
      onSelect: function(formattedDate, date, inst) {

        ff = $(targetID + ' #dates').find('.active').find('input').val();
        switch (ff) {
          case "DAY":
            format = "YYYY-MM-DD";
            break;
          case "WEEK":
            format = "YY-WW";

            break;
          case "MONTH":
            format = "YY-MM";

            break;
          case "YEAR":
            format = "YYYY";

            break;
          default:
            format = "YYYY-MM-DD";


        }
        //ddate=formattedDate.split(" | ")
        // from = moment(formattedDate).format(format)
        from = formattedDate;
        //fto=moment(date[1]).format(format)
        //myLog("DATA DA INVIARE ", formattedDate);

      }
    }).data('datepicker');

    $(targetID + ' #dates').on('click', 'label', function(e) {
      e.preventDefault()
     console.log("CLICK SU LABEL",targetID,activeTab);
      filters = {};

      switch ($(this).find('input').val()) {
        case "DAY":
          format = "YYYY-MM-DD";
          if(activeTab=='report_any'){
            from = moment().subtract(7, 'days').format(format)
          }else{
            from = moment().subtract(1, 'months').format(format)
          }
          //to = moment().format(format)
          calendarview = 'days';
          break;
        case "WEEK":
          format = "YY-WW";
          from = moment().subtract(1, 'years').format(format)
          // to = moment().format(format)
          calendarview = 'day'
          break;
        case "MONTH":
          format = "YY-MM";
          from = moment().subtract(1, 'years').format(format)
          // to = moment().format(format)
          calendarview = 'months';
          break;
        case "YEAR":
          format = "YYYY";
          from = moment().subtract(5, 'years').format(format)
          // to = moment().format(format)
          calendarview = 'years'
          break;
        default:
          format = "YYYY-MM-DD";
          from = moment().subtract(5, 'days').format(format)
          // to = moment().format(format)
          calendarview = 'days'

      }


      //datepicker.minView=calendarview;
      datepicker.view = calendarview;

      datapicker.dateFormat = format.toLowerCase();
      ////myLog("CAMBIO DATA ", $(this).find('input').val(), calendarview);
      //$('input[name="daterange"]').attr('data-date-format', format.toLowerCase()).val(from + ' | ' + to);
      if ($(this).find('input').val() != 'WEEK') {
        datepicker.update({
          'dateFormat': format.toLowerCase(),
          'minView': calendarview,
          'maxDate': new Date()
        })

      } else {
        datapicker.maxDate = new Date();

      }
      $('input[name="daterange"]').attr('value', from).val(from)
      ////myLog("DP DATA",datepicker);
      // if($(this).find('input').val()!="WEEK"){
      //   $('input[name="daterange"]').attr('data-date-format', format.toLowerCase()).val(from + ' | ' + to)
      // }
    })
    if (node.nome == "ATTIVITA") {
      from = moment().subtract(5, 'days').format('YYYY-MM-DD')
      datepicker.update({
        'dateFormat': format.toLowerCase(),
        'minView': 'days',
        'maxDate': new Date()
      })
      $('input[name="daterange"]').attr('value', from).val(from)
    }
    //$('input[name="daterange"]').daterangepicker();
    // $(".date-from").attr("value", start);
    // $(".date-to").attr("value", end);
    //$('body');
    $(targetID + ' #dates').find('label.active').trigger('click');

  }


  function selectBox(name, obj, multiple = true) {
    console.log("SELECT BOX ", obj);
    var multiple = (multiple) ? 'multiple' : '';
    var selectbox = '<div class="form-inline">\n\t<div class="form-group col-xs-2 col-xs-4">\n\t<select class="selectpicker show-tick" ' + multiple + ' title="' + name +
      '" data-max-options="1" data-actions-box="false" data-live-search="true" name="' + name + '" id="' + name + '">\n\t<option data-hidden="true">-</option>';

    values = obj;

    for (var p in obj) {
      selectbox += "<option value=" + obj[p].val + ">" + obj[p].nome + "</option>\n";
      ////myLog("P ",p," FILTER ",obj[p]);
    }
    selectbox += "</select></div></div>\n";
    //$('#'+name).selectpicker("refresh");
    //alert("NAME "+$('#'+name));
    return selectbox;
  }

  function bfsdatepicker(from,isrange) {
    return '<div class="form-inline"><div class="form-group col-xs-2 col-xs-4">\n\t<div class="input-group input-daterange">\n\t<input type="text" name="daterange" class="form-control" data-language="en" data-date-format="yyyy-mm-dd" data-min-view="days" data-range="'+isrange+'" data-multiple-dates-separator=" | " value="' +
      from + '">\n\t</div></div></div>';
  }

  function option(name, type, obj) {
    //TYPE "RADIO" or "CHECKBOX"
    //OBJ ARRAY
    ////myLog("OPTION ", name, type, obj);
    var ret = '<div id="' + name + '" data-toggle="buttons" class="btn-group btn-group-justified" role="group">\n\t';
    var counter = 0;
    for (var p in obj) {
      checked = (counter == 0) ? 'active' : '';
      ret += '<label class="btn btn-default btn-circle ' + checked + '"><input type="' + type + '" name="q' + counter + '"  value="' + obj[p].val + '">' + obj[p].nome + '</label>\n';
      counter++;
    }
    ret += '</div>';
    return ret;
  }

  /* ┌──────────────────────────────────────┐
   * │                                      │
   * │            LOAD FILE JSON            │
   * │                                      │
   * └──────────────────────────────────────┘
   */

  function openFileConfig() {
    config = report = null
    $.ajax({
      dataType: "json",
      url: path.join(DOCUMENTS, "lookin", "config.json"),
      success: function(data) {
        config = data;
        report = data.report;
        $('p.username').html("Hello <b>" + data.app[0].nominativo + "</b>");
        //alert("USER "+data.user.username+" PWD "+data.user.password);
        //myLog("DATA REPORT ", data);
        //$('a[data-toggle="tab"]').eq(0).trigger('click')
        //reportOption(data[activeTab], $('.reportselect:eq(0)'));
        return data;
      }
    })

  }

  function reportOption(data, tab) {
    console.info("REPORT OPTION ", data);
    var reportoption = '';
    $(data).each(function(key, val) {
     console.log("VAL ", this.isActive);
      if(this.isActive==1){
      reportoption += '<option value="' + key + '" ';
      if (val.active == 0) {
        reportoption += ' disabled';
      }
      reportoption += ' >' + val.nome + '</option>';
    }
    })
    $(tab).empty().append(reportoption).selectpicker("refresh");
  }



  function getObjects(obj, key, val) {
    var objects = [];
    for (var i in obj) {

      if (!obj.hasOwnProperty(i)) continue;
      if (typeof obj[i] == 'object') {

        objects = objects.concat(getObjects(obj[i], key, val));
      } else if (i == key && obj[key] == val) {
        ////myLog("AGGIUNGO L'OGGETTO ",obj);
        objects.push(obj);
      }
    }
    return objects;
  }

  function findObject(obj, key, val) {
    return obj[key] == val

  }

  function closeAllWindows() {

    try {
      ////myLog("CHIUDO TUTTE LE FINESTRE");
      if (windows.length > 0) {
        for (var w in windows) {
          windows[w].close();
        }
      } else {
        return true;
      }
    } catch (err) {
      ////myLog("ERRORE ", err);
      return false
    }
    return true;

  }

  function myLog() {
    data = '';
    for (var i = 0; i < arguments.length; i++) {
      if (typeof(arguments[i]) == 'Object') {
        o = arguments[i];
        for (var v in o) {
          data += "{" + v + " | " + o[v] + "}";
        }
      } else {
        data += arguments[i] + " | ";
      }

    }
    fs.appendFile(path.join(app.getPath('documents'), 'lookin', 'log.txt'), "[" + moment().format("YYYY-MM-DD - hh:mm:ss") + "]\t => " + data + "\r\n", function(err) {

    })
  }
</script>

</html>
